<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="_users_8c_source" xml:lang="en-US">
<title>users.c</title>
<indexterm><primary>src/users.c</primary></indexterm>
Go to the documentation of this file.<programlisting linenumbering="unnumbered"><anchor xml:id="_users_8c_source_1l00001"/>00001 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_common_8h">include/common.h</link>&quot;</emphasis>
<anchor xml:id="_users_8c_source_1l00002"/>00002 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_users_8h">include/users.h</link>&quot;</emphasis>
<anchor xml:id="_users_8c_source_1l00003"/>00003 
<anchor xml:id="_users_8c_source_1l00004"/><link linkend="_users_8c_1a6552301543b6d6d55cb62f88d40300a0">00004</link> <emphasis role="preprocessor">#define&#32;REWARD(amount,&#32;reward)&#32;(ceil(((reward&#32;*&#32;(amount))&#32;/&#32;100.0)))</emphasis>
<anchor xml:id="_users_8c_source_1l00005"/>00005 <emphasis role="comment">/*</emphasis>
<anchor xml:id="_users_8c_source_1l00006"/>00006 <emphasis role="comment">&#32;*&#32;NON&#32;active&#32;wait,&#32;the&#32;time&#32;is&#32;equivalent&#32;to&#32;the</emphasis>
<anchor xml:id="_users_8c_source_1l00007"/>00007 <emphasis role="comment">&#32;*&#32;verification&#32;algorithms&#32;that&#32;happen&#32;in&#32;&quot;real&quot;&#32;blockchains</emphasis>
<anchor xml:id="_users_8c_source_1l00008"/>00008 <emphasis role="comment">&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00009"/>00009 
<anchor xml:id="_users_8c_source_1l00010"/>00010 <emphasis role="comment">/*</emphasis>
<anchor xml:id="_users_8c_source_1l00011"/>00011 <emphasis role="comment">&#32;*&#32;Need&#32;to&#32;implement&#32;a&#32;way&#32;to&#32;send&#32;s&#32;transaction</emphasis>
<anchor xml:id="_users_8c_source_1l00012"/>00012 <emphasis role="comment">&#32;*&#32;signal,&#32;we&#32;can&#32;utilize&#32;a&#32;user&#32;defined&#32;signal</emphasis>
<anchor xml:id="_users_8c_source_1l00013"/>00013 <emphasis role="comment">&#32;*&#32;handler.</emphasis>
<anchor xml:id="_users_8c_source_1l00014"/>00014 <emphasis role="comment">&#32;*&#32;We&#32;also&#32;need&#32;to&#32;account&#32;for&#32;the&#32;signal&#32;SIGINT&#32;(CTRL-C).</emphasis>
<anchor xml:id="_users_8c_source_1l00015"/>00015 <emphasis role="comment">&#32;*&#32;Maybe&#32;we&#32;can&#32;implement&#32;some&#32;sort&#32;of&#32;graphic&#32;way&#32;to&#32;visualize</emphasis>
<anchor xml:id="_users_8c_source_1l00016"/>00016 <emphasis role="comment">&#32;*&#32;child&#32;processes&#32;(nodes&#32;and&#32;user)&#32;so&#32;that&#32;we&#32;can&#32;choose</emphasis>
<anchor xml:id="_users_8c_source_1l00017"/>00017 <emphasis role="comment">&#32;*&#32;the&#32;PID&#32;on&#32;which&#32;to&#32;send&#32;the&#32;signal&#32;to.</emphasis>
<anchor xml:id="_users_8c_source_1l00018"/>00018 <emphasis role="comment">&#32;*&#32;--&#32;user-defined&#32;signal&#32;handlers&#32;are&#32;inherited&#32;by&#32;the&#32;child&#32;processes&#32;--</emphasis>
<anchor xml:id="_users_8c_source_1l00019"/>00019 <emphasis role="comment">&#32;*&#32;so&#32;it&apos;s&#32;better&#32;to&#32;handle&#32;them&#32;in&#32;the&#32;master&#32;program</emphasis>
<anchor xml:id="_users_8c_source_1l00020"/>00020 <emphasis role="comment">&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00021"/>00021 
<anchor xml:id="_users_8c_source_1l00022"/>00022 <emphasis role="comment">/*&#32;void&#32;wait_for_incoming_transaction()&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00023"/>00023 
<anchor xml:id="_users_8c_source_1l00024"/>00024 <emphasis role="comment">/*</emphasis>
<anchor xml:id="_users_8c_source_1l00025"/>00025 <emphasis role="comment">&#32;======================</emphasis>
<anchor xml:id="_users_8c_source_1l00026"/>00026 <emphasis role="comment">&#32;||&#32;GLOBAL&#32;VARIABLES&#32;||</emphasis>
<anchor xml:id="_users_8c_source_1l00027"/>00027 <emphasis role="comment">&#32;======================</emphasis>
<anchor xml:id="_users_8c_source_1l00028"/>00028 <emphasis role="comment">&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00029"/>00029 
<anchor xml:id="_users_8c_source_1l00030"/>00030 <emphasis role="comment">/*&#32;parameters&#32;of&#32;simulation&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00031"/><link linkend="_users_8c_1a963935917aae796fbb8f2728703adf04">00031</link> <emphasis role="keyword">struct&#32;</emphasis><link linkend="_structparameters">parameters</link>&#32;*<link linkend="_users_8c_1a963935917aae796fbb8f2728703adf04">par</link>;
<anchor xml:id="_users_8c_source_1l00032"/><link linkend="_users_8c_1af667a518a4feef7b7540ebac0cd618cf">00032</link> <link linkend="_structuser__t">user</link>&#32;*<link linkend="_users_8c_1af667a518a4feef7b7540ebac0cd618cf">usersPID</link>;
<anchor xml:id="_users_8c_source_1l00033"/><link linkend="_users_8c_1a803b35477f039b41487c3b1abee12b80">00033</link> <link linkend="_structnode__t">node</link>&#32;*<link linkend="_users_8c_1a803b35477f039b41487c3b1abee12b80">nodesPID</link>;
<anchor xml:id="_users_8c_source_1l00034"/><link linkend="_users_8c_1a61246e5e608d3240fbbee97c978af351">00034</link> <link linkend="_structledger__t">ledger</link>&#32;*<link linkend="_users_8c_1a61246e5e608d3240fbbee97c978af351">mainLedger</link>;
<anchor xml:id="_users_8c_source_1l00035"/>00035 
<anchor xml:id="_users_8c_source_1l00036"/><link linkend="_users_8c_1ae520355298e7bac453a556eeab7df45f">00036</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_users_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>;
<anchor xml:id="_users_8c_source_1l00037"/><link linkend="_users_8c_1abba475816ec0c77dd5821e7fa9ab4207">00037</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_users_8c_1abba475816ec0c77dd5821e7fa9ab4207">queueID</link>;
<anchor xml:id="_users_8c_source_1l00038"/>00038 
<anchor xml:id="_users_8c_source_1l00039"/><link linkend="_users_8c_1a2ac06e48b5c5d403186f052dbefc3fe7">00039</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_users_8c_1a2ac06e48b5c5d403186f052dbefc3fe7">currBalance</link>;
<anchor xml:id="_users_8c_source_1l00040"/><link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">00040</link> pid_t&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>;
<anchor xml:id="_users_8c_source_1l00041"/><link linkend="_users_8c_1af230afc0b56da7230ff9dacabbac1e25">00041</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_users_8c_1af230afc0b56da7230ff9dacabbac1e25">outGoingTransactions</link>;&#32;<emphasis role="comment">/*&#32;accumulate&#32;amount&#32;of&#32;transactions&#32;sent&#32;but&#32;yet&#32;to&#32;be&#32;received&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00042"/><link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">00042</link> <link linkend="_structtransaction__t">transaction</link>&#32;<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>;
<anchor xml:id="_users_8c_source_1l00043"/>00043 
<anchor xml:id="_users_8c_source_1l00044"/>00044 <emphasis role="comment">/*</emphasis>
<anchor xml:id="_users_8c_source_1l00045"/>00045 <emphasis role="comment">&#32;======================</emphasis>
<anchor xml:id="_users_8c_source_1l00046"/>00046 <emphasis role="comment">&#32;||&#32;&#32;&#32;&#32;FUNCTIONS&#32;&#32;&#32;&#32;&#32;||</emphasis>
<anchor xml:id="_users_8c_source_1l00047"/>00047 <emphasis role="comment">&#32;======================</emphasis>
<anchor xml:id="_users_8c_source_1l00048"/>00048 <emphasis role="comment">&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00049"/>00049 
<anchor xml:id="_users_8c_source_1l00050"/>00050 <emphasis role="comment">/*&#32;returns&#32;index&#32;of&#32;where&#32;user&#32;with&#32;PID_toSearch&#32;is&#32;located&#32;in&#32;usersPID[]&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00051"/><link linkend="_users_8h_1a7f41cf6401b33c2055d553d8315decaa">00051</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_users_8c_1a7f41cf6401b33c2055d553d8315decaa">get_pid_userIndex</link>(<emphasis role="keywordtype">int</emphasis>&#32;PID_toSearch)
<anchor xml:id="_users_8c_source_1l00052"/>00052 {
<anchor xml:id="_users_8c_source_1l00053"/>00053 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;i;
<anchor xml:id="_users_8c_source_1l00054"/>00054 
<anchor xml:id="_users_8c_source_1l00055"/>00055 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;i&#32;&lt;&#32;<link linkend="_users_8c_1a963935917aae796fbb8f2728703adf04">par</link>-&gt;<link linkend="_structparameters_1a1a7bfa0882f03d573b4e419d02f041f8">SO_USER_NUM</link>;&#32;i++)
<anchor xml:id="_users_8c_source_1l00056"/>00056 &#32;&#32;&#32;&#32;{
<anchor xml:id="_users_8c_source_1l00057"/>00057 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_users_8c_1af667a518a4feef7b7540ebac0cd618cf">usersPID</link>[i].pid&#32;==&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>)
<anchor xml:id="_users_8c_source_1l00058"/>00058 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;i;
<anchor xml:id="_users_8c_source_1l00059"/>00059 &#32;&#32;&#32;&#32;}
<anchor xml:id="_users_8c_source_1l00060"/>00060 
<anchor xml:id="_users_8c_source_1l00061"/>00061 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;-1;
<anchor xml:id="_users_8c_source_1l00062"/>00062 }
<anchor xml:id="_users_8c_source_1l00063"/>00063 
<anchor xml:id="_users_8c_source_1l00064"/>00064 <emphasis role="comment">/*&#32;returns&#32;a&#32;random&#32;PID&#32;of&#32;a&#32;non-dead&#32;user&#32;from&#32;usersPID[]&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00065"/><link linkend="_users_8h_1aaf15d0912c5fa42321118d1c652551d2">00065</link> pid_t&#32;<link linkend="_users_8c_1aaf15d0912c5fa42321118d1c652551d2">get_random_userPID</link>()
<anchor xml:id="_users_8c_source_1l00066"/>00066 {
<anchor xml:id="_users_8c_source_1l00067"/>00067 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;index;
<anchor xml:id="_users_8c_source_1l00068"/>00068 &#32;&#32;&#32;&#32;pid_t&#32;val&#32;=&#32;0;
<anchor xml:id="_users_8c_source_1l00069"/>00069 
<anchor xml:id="_users_8c_source_1l00070"/>00070 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">do</emphasis>
<anchor xml:id="_users_8c_source_1l00071"/>00071 &#32;&#32;&#32;&#32;{
<anchor xml:id="_users_8c_source_1l00072"/>00072 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;index&#32;=&#32;<link linkend="_common_8h_1a0d7644a795aa2dd33f01ef184f3f672a">RAND</link>(0,&#32;<link linkend="_users_8c_1a963935917aae796fbb8f2728703adf04">par</link>-&gt;<link linkend="_structparameters_1a1a7bfa0882f03d573b4e419d02f041f8">SO_USER_NUM</link>&#32;-&#32;1);
<anchor xml:id="_users_8c_source_1l00073"/>00073 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:user:&#32;%d&#32;index&#32;is&#32;%d\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;index))
<anchor xml:id="_users_8c_source_1l00074"/>00074 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;usersPID[%d]\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;index));
<anchor xml:id="_users_8c_source_1l00075"/>00075 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_users_8c_1af667a518a4feef7b7540ebac0cd618cf">usersPID</link>[index].status&#32;!=&#32;dead)
<anchor xml:id="_users_8c_source_1l00076"/>00076 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;val&#32;=&#32;<link linkend="_users_8c_1af667a518a4feef7b7540ebac0cd618cf">usersPID</link>[index].<link linkend="_structuser__t_1ae0d46a978d5cd6707411f276ad869b9c">pid</link>;
<anchor xml:id="_users_8c_source_1l00077"/>00077 &#32;&#32;&#32;&#32;}&#32;<emphasis role="keywordflow">while</emphasis>&#32;(!val);
<anchor xml:id="_users_8c_source_1l00078"/>00078 
<anchor xml:id="_users_8c_source_1l00079"/>00079 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;val;
<anchor xml:id="_users_8c_source_1l00080"/>00080 }
<anchor xml:id="_users_8c_source_1l00081"/>00081 
<anchor xml:id="_users_8c_source_1l00082"/>00082 <emphasis role="comment">/*&#32;returns&#32;a&#32;random&#32;PID&#32;of&#32;an&#32;available&#32;node&#32;from&#32;nodesPID[]&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00083"/><link linkend="_users_8h_1a7a26cf1c5a9c15d42c4f3caeaa179b0e">00083</link> pid_t&#32;<link linkend="_users_8c_1a7a26cf1c5a9c15d42c4f3caeaa179b0e">get_random_nodePID</link>()
<anchor xml:id="_users_8c_source_1l00084"/>00084 {
<anchor xml:id="_users_8c_source_1l00085"/>00085 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;index;
<anchor xml:id="_users_8c_source_1l00086"/>00086 &#32;&#32;&#32;&#32;pid_t&#32;val&#32;=&#32;0;
<anchor xml:id="_users_8c_source_1l00087"/>00087 
<anchor xml:id="_users_8c_source_1l00088"/>00088 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">do</emphasis>
<anchor xml:id="_users_8c_source_1l00089"/>00089 &#32;&#32;&#32;&#32;{
<anchor xml:id="_users_8c_source_1l00090"/>00090 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;index&#32;=&#32;<link linkend="_common_8h_1a0d7644a795aa2dd33f01ef184f3f672a">RAND</link>(0,&#32;<link linkend="_users_8c_1a963935917aae796fbb8f2728703adf04">par</link>-&gt;<link linkend="_structparameters_1a379d08051847c4f98268a27001b06261">SO_NODES_NUM</link>&#32;-&#32;1);
<anchor xml:id="_users_8c_source_1l00091"/>00091 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:user:&#32;%d&#32;index&#32;is&#32;%d\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;index))
<anchor xml:id="_users_8c_source_1l00092"/>00092 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;nodesPID[%d]\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;index));
<anchor xml:id="_users_8c_source_1l00093"/>00093 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_users_8c_1a803b35477f039b41487c3b1abee12b80">nodesPID</link>[index].status&#32;==&#32;available)
<anchor xml:id="_users_8c_source_1l00094"/>00094 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;val&#32;=&#32;<link linkend="_users_8c_1a803b35477f039b41487c3b1abee12b80">nodesPID</link>[index].<link linkend="_structnode__t_1ae0d46a978d5cd6707411f276ad869b9c">pid</link>;
<anchor xml:id="_users_8c_source_1l00095"/>00095 &#32;&#32;&#32;&#32;}&#32;<emphasis role="keywordflow">while</emphasis>&#32;(!val);
<anchor xml:id="_users_8c_source_1l00096"/>00096 
<anchor xml:id="_users_8c_source_1l00097"/>00097 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;val;
<anchor xml:id="_users_8c_source_1l00098"/>00098 }
<anchor xml:id="_users_8c_source_1l00099"/>00099 
<anchor xml:id="_users_8c_source_1l00100"/>00100 <emphasis role="comment">/*&#32;safely&#32;updates&#32;status&#32;of&#32;user&#32;to&#32;statusToSet:&#32;0&#32;alive,&#32;1&#32;broke,&#32;2&#32;dead&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00101"/><link linkend="_users_8c_1a959cd23eec8cbe2e56f5cc915e24ec2b">00101</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_users_8c_1a959cd23eec8cbe2e56f5cc915e24ec2b">update_status</link>(<emphasis role="keywordtype">int</emphasis>&#32;statusToSet)
<anchor xml:id="_users_8c_source_1l00102"/>00102 {
<anchor xml:id="_users_8c_source_1l00103"/>00103 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;i&#32;=&#32;<link linkend="_users_8c_1a7f41cf6401b33c2055d553d8315decaa">get_pid_userIndex</link>(<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>);
<anchor xml:id="_users_8c_source_1l00104"/>00104 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(i&#32;==&#32;-1)
<anchor xml:id="_users_8c_source_1l00105"/>00105 &#32;&#32;&#32;&#32;{
<anchor xml:id="_users_8c_source_1l00106"/>00106 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;failed&#32;to&#32;find&#32;myself&#32;in&#32;usersPID[]&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>));
<anchor xml:id="_users_8c_source_1l00107"/>00107 &#32;&#32;&#32;&#32;}
<anchor xml:id="_users_8c_source_1l00108"/>00108 
<anchor xml:id="_users_8c_source_1l00109"/>00109 &#32;&#32;&#32;&#32;<link linkend="_sem_8c_1a8a9bfe4b1b46fa8a09858b192d6e8764">sem_reserve</link>(<link linkend="_users_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>,&#32;1);
<anchor xml:id="_users_8c_source_1l00110"/>00110 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1af667a518a4feef7b7540ebac0cd618cf">usersPID</link>[i].<link linkend="_structuser__t_1a2f25fcb4ca138820780f3fc6ee156d17">status</link>&#32;=&#32;statusToSet;
<anchor xml:id="_users_8c_source_1l00111"/>00111 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(statusToSet&#32;==&#32;2)
<anchor xml:id="_users_8c_source_1l00112"/>00112 &#32;&#32;&#32;&#32;{
<anchor xml:id="_users_8c_source_1l00113"/>00113 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">/*usersPrematurelyDead++;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00114"/>00114 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;dead&#32;increased\n&quot;</emphasis>));
<anchor xml:id="_users_8c_source_1l00115"/>00115 &#32;&#32;&#32;&#32;}
<anchor xml:id="_users_8c_source_1l00116"/>00116 &#32;&#32;&#32;&#32;<link linkend="_sem_8c_1a3fbb448c9f985007f6030b3927357b5c">sem_release</link>(<link linkend="_users_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>,&#32;1);
<anchor xml:id="_users_8c_source_1l00117"/>00117 }
<anchor xml:id="_users_8c_source_1l00118"/>00118 
<anchor xml:id="_users_8c_source_1l00119"/>00119 <emphasis role="comment">/*&#32;attaches&#32;ipc&#32;objects&#32;based&#32;on&#32;IDs&#32;passed&#32;via&#32;arguments&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00120"/><link linkend="_users_8c_1add037018869db8fbc785a9e0b24dd020">00120</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_users_8c_1add037018869db8fbc785a9e0b24dd020">attach_ipc_objects</link>(<emphasis role="keywordtype">char</emphasis>&#32;**argv)
<anchor xml:id="_users_8c_source_1l00121"/>00121 {
<anchor xml:id="_users_8c_source_1l00122"/>00122 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1a963935917aae796fbb8f2728703adf04">par</link>&#32;=&#32;shmat(<link linkend="_common_8h_1a8dc6d4d682e4f826ef23717f1b28d60c">PARAMETERS_ARGV</link>,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>,&#32;0);
<anchor xml:id="_users_8c_source_1l00123"/>00123 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users&#32;%d&#32;par-&gt;SO_RETRY&#32;%d\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;<link linkend="_users_8c_1a963935917aae796fbb8f2728703adf04">par</link>-&gt;<link linkend="_structparameters_1ac2861693c2d9121c5ecad90de2189690">SO_RETRY</link>))
<anchor xml:id="_users_8c_source_1l00124"/>00124 &#32;&#32;&#32;&#32;<link linkend="_common_8h_1a8251bcdfc5c83845e0834adf211de033">TEST_ERROR</link>
<anchor xml:id="_users_8c_source_1l00125"/>00125 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1af667a518a4feef7b7540ebac0cd618cf">usersPID</link>&#32;=&#32;shmat(<link linkend="_common_8h_1abdb8ae9e0caeeaa6b02791a1991ec34e">USERS_PID_ARGV</link>,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>,&#32;0);
<anchor xml:id="_users_8c_source_1l00126"/>00126 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;usersPID[0]&#32;=&#32;%d,&#32;usersPID[3]&#32;=&#32;%d\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;<link linkend="_users_8c_1af667a518a4feef7b7540ebac0cd618cf">usersPID</link>[0],&#32;<link linkend="_users_8c_1af667a518a4feef7b7540ebac0cd618cf">usersPID</link>[3]))
<anchor xml:id="_users_8c_source_1l00127"/>00127 &#32;&#32;&#32;&#32;<link linkend="_common_8h_1a8251bcdfc5c83845e0834adf211de033">TEST_ERROR</link>
<anchor xml:id="_users_8c_source_1l00128"/>00128 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1a803b35477f039b41487c3b1abee12b80">nodesPID</link>&#32;=&#32;shmat(<link linkend="_common_8h_1aa26907b48e282ee32e55a0f21d90c651">NODES_PID_ARGV</link>,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>,&#32;0);
<anchor xml:id="_users_8c_source_1l00129"/>00129 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;nodesPID[0]&#32;=&#32;%d,&#32;nodesPID[3]&#32;=&#32;%d\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;<link linkend="_users_8c_1a803b35477f039b41487c3b1abee12b80">nodesPID</link>[0],&#32;<link linkend="_users_8c_1a803b35477f039b41487c3b1abee12b80">nodesPID</link>[3]))
<anchor xml:id="_users_8c_source_1l00130"/>00130 &#32;&#32;&#32;&#32;<link linkend="_common_8h_1a8251bcdfc5c83845e0834adf211de033">TEST_ERROR</link>
<anchor xml:id="_users_8c_source_1l00131"/>00131 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1a61246e5e608d3240fbbee97c978af351">mainLedger</link>&#32;=&#32;shmat(<link linkend="_common_8h_1acbabb34d7448290aade7aa93bb0c09ca">LEDGER_ARGV</link>,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>,&#32;0);
<anchor xml:id="_users_8c_source_1l00132"/>00132 &#32;&#32;&#32;&#32;<link linkend="_common_8h_1a8251bcdfc5c83845e0834adf211de033">TEST_ERROR</link>
<anchor xml:id="_users_8c_source_1l00133"/>00133 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>&#32;=&#32;<link linkend="_common_8h_1a6b6ae98a167eeb9050cca5e9f9e5cf37">SEM_ID_ARGV</link>;
<anchor xml:id="_users_8c_source_1l00134"/>00134 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;semID&#32;is&#32;%d\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;<link linkend="_users_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>));
<anchor xml:id="_users_8c_source_1l00135"/>00135 }
<anchor xml:id="_users_8c_source_1l00136"/>00136 
<anchor xml:id="_users_8c_source_1l00137"/>00137 <emphasis role="comment">/*&#32;use&#32;nodePID&#32;as&#32;key&#32;for&#32;msgget&#32;and&#32;check&#32;for&#32;errors&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00138"/><link linkend="_users_8h_1a9cceef0ffc7483e71c1cc4652a05cc1c">00138</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_users_8c_1a9cceef0ffc7483e71c1cc4652a05cc1c">queue_to_pid</link>(pid_t&#32;nodePID)
<anchor xml:id="_users_8c_source_1l00139"/>00139 {
<anchor xml:id="_users_8c_source_1l00140"/>00140 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1abba475816ec0c77dd5821e7fa9ab4207">queueID</link>&#32;=&#32;msgget(nodePID,&#32;IPC_CREAT&#32;|&#32;0600);
<anchor xml:id="_users_8c_source_1l00141"/>00141 &#32;&#32;&#32;&#32;<link linkend="_common_8h_1a8251bcdfc5c83845e0834adf211de033">TEST_ERROR</link>
<anchor xml:id="_users_8c_source_1l00142"/>00142 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;-&gt;&#32;%d&#32;queueID&#32;%d\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;nodePID,&#32;<link linkend="_users_8c_1abba475816ec0c77dd5821e7fa9ab4207">queueID</link>))
<anchor xml:id="_users_8c_source_1l00143"/>00143 }
<anchor xml:id="_users_8c_source_1l00144"/>00144 
<anchor xml:id="_users_8c_source_1l00145"/>00145 <emphasis role="comment">/*&#32;initializes&#32;transaction&#32;values&#32;and&#32;sets&#32;it&#32;to&#32;pending&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00146"/><link linkend="_users_8h_1a1e2d07708f3abf72150e65545e8bef23">00146</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_users_8c_1aad9c23bdb64131e376665a8dd7085f9b">transaction_init</link>(pid_t&#32;userPID,&#32;<emphasis role="keywordtype">int</emphasis>&#32;amount,&#32;<emphasis role="keywordtype">int</emphasis>&#32;reward)
<anchor xml:id="_users_8c_source_1l00147"/>00147 {
<anchor xml:id="_users_8c_source_1l00148"/>00148 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis>timespec&#32;exactTime;
<anchor xml:id="_users_8c_source_1l00149"/>00149 
<anchor xml:id="_users_8c_source_1l00150"/>00150 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1a36060e3785ebad7b278cb01d5159c0c5">sender</link>&#32;=&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>;
<anchor xml:id="_users_8c_source_1l00151"/>00151 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1a3c01e8bf1e61ee67a25113f3db1a32b8">receiver</link>&#32;=&#32;userPID;
<anchor xml:id="_users_8c_source_1l00152"/>00152 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1a14236de313193a14b4dbdf442bcf2bb9">amount</link>&#32;=&#32;amount;
<anchor xml:id="_users_8c_source_1l00153"/>00153 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1af571e76d8e59b8452f38407799272e4a">reward</link>&#32;=&#32;reward;
<anchor xml:id="_users_8c_source_1l00154"/>00154 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1a95a086466eb975b4da063388dd397dd3">status</link>&#32;=&#32;pending;
<anchor xml:id="_users_8c_source_1l00155"/>00155 &#32;&#32;&#32;&#32;clock_gettime(CLOCK_REALTIME,&#32;&amp;exactTime);
<anchor xml:id="_users_8c_source_1l00156"/>00156 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1a2aace03835c4d951b3dee117b328ef87">timestamp</link>&#32;=&#32;exactTime;
<anchor xml:id="_users_8c_source_1l00157"/>00157 }
<anchor xml:id="_users_8c_source_1l00158"/>00158 
<anchor xml:id="_users_8c_source_1l00159"/>00159 <emphasis role="comment">/*&#32;initializes&#32;signal&#32;handlers&#32;for&#32;SIGINT&#32;and&#32;SIGUSR1&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00160"/><link linkend="_users_8c_1a54d1d8f51781e0b3c58e16d3e04f2f74">00160</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_users_8c_1a54d1d8f51781e0b3c58e16d3e04f2f74">signal_handlers_init</link>(<emphasis role="keyword">struct</emphasis>&#32;sigaction&#32;*saUSR1,&#32;<emphasis role="keyword">struct</emphasis>&#32;sigaction&#32;*saINT)
<anchor xml:id="_users_8c_source_1l00161"/>00161 {
<anchor xml:id="_users_8c_source_1l00162"/>00162 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;--&#32;SIGNAL&#32;HANDLERS&#32;--</emphasis>
<anchor xml:id="_users_8c_source_1l00163"/>00163 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;*&#32;first&#32;set&#32;all&#32;bytes&#32;of&#32;sigation&#32;to&#32;0</emphasis>
<anchor xml:id="_users_8c_source_1l00164"/>00164 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;*&#32;then&#32;initialize&#32;sa.handler&#32;to&#32;a&#32;pointer&#32;to</emphasis>
<anchor xml:id="_users_8c_source_1l00165"/>00165 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;*&#32;the&#32;function&#32;user_transaction/interrupt_handle</emphasis>
<anchor xml:id="_users_8c_source_1l00166"/>00166 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;*&#32;then&#32;set&#32;the&#32;handler&#32;to&#32;handle&#32;SIUSR1/SIGINT&#32;signals</emphasis>
<anchor xml:id="_users_8c_source_1l00167"/>00167 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;*&#32;((struct&#32;sigaction&#32;*oldact)&#32;=&#32;NULL)</emphasis>
<anchor xml:id="_users_8c_source_1l00168"/>00168 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00169"/>00169 &#32;&#32;&#32;&#32;saUSR1-&gt;sa_handler&#32;=&#32;<link linkend="_users_8c_1a2419f7ac6a2d2282e04a8535b4b5c2f9">user_transactions_handle</link>;
<anchor xml:id="_users_8c_source_1l00170"/>00170 &#32;&#32;&#32;&#32;saINT-&gt;sa_handler&#32;=&#32;<link linkend="_users_8c_1a9aab3bf870349762f604cebd8633aea5">user_interrupt_handle</link>;
<anchor xml:id="_users_8c_source_1l00171"/>00171 &#32;&#32;&#32;&#32;sigaction(SIGUSR1,&#32;saUSR1,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>);
<anchor xml:id="_users_8c_source_1l00172"/>00172 &#32;&#32;&#32;&#32;sigaction(SIGINT,&#32;saINT,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>);
<anchor xml:id="_users_8c_source_1l00173"/>00173 }
<anchor xml:id="_users_8c_source_1l00174"/>00174 
<anchor xml:id="_users_8c_source_1l00175"/>00175 <emphasis role="comment">/*&#32;send&#32;transaction&#32;currTrans&#32;to&#32;user&#32;userPID&#32;via&#32;node&#32;nodePID&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00176"/><link linkend="_users_8h_1af881b5c5f39090e7fc6c5c5d6630c7cb">00176</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_users_8c_1af881b5c5f39090e7fc6c5c5d6630c7cb">send_transaction</link>()
<anchor xml:id="_users_8c_source_1l00177"/>00177 {
<anchor xml:id="_users_8c_source_1l00178"/>00178 &#32;&#32;&#32;&#32;msgsnd(<link linkend="_users_8c_1abba475816ec0c77dd5821e7fa9ab4207">queueID</link>,&#32;&amp;<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>,&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_structtransaction__t">transaction</link>),&#32;0);
<anchor xml:id="_users_8c_source_1l00179"/>00179 &#32;&#32;&#32;&#32;<link linkend="_common_8h_1a8251bcdfc5c83845e0834adf211de033">TEST_ERROR</link>
<anchor xml:id="_users_8c_source_1l00180"/>00180 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1a2ac06e48b5c5d403186f052dbefc3fe7">currBalance</link>&#32;-=&#32;(<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1a14236de313193a14b4dbdf442bcf2bb9">amount</link>&#32;+&#32;<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1af571e76d8e59b8452f38407799272e4a">reward</link>);
<anchor xml:id="_users_8c_source_1l00181"/>00181 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1af230afc0b56da7230ff9dacabbac1e25">outGoingTransactions</link>&#32;+=&#32;(<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1a14236de313193a14b4dbdf442bcf2bb9">amount</link>&#32;+&#32;<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1af571e76d8e59b8452f38407799272e4a">reward</link>);
<anchor xml:id="_users_8c_source_1l00182"/>00182 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">switch</emphasis>&#32;(<link linkend="_common_8h_1ad65a8842cc674e3ddf69355898c0ecbf">errno</link>)
<anchor xml:id="_users_8c_source_1l00183"/>00183 &#32;&#32;&#32;&#32;{
<anchor xml:id="_users_8c_source_1l00184"/>00184 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;EACCES:
<anchor xml:id="_users_8c_source_1l00185"/>00185 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;:users&#32;%d&#32;no&#32;write&#32;permission&#32;on&#32;queue\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>);
<anchor xml:id="_users_8c_source_1l00186"/>00186 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="_users_8c_source_1l00187"/>00187 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;EAGAIN:
<anchor xml:id="_users_8c_source_1l00188"/>00188 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;queue&#32;full\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>);&#32;<emphasis role="comment">/*&#32;keep&#32;if&#32;we&#32;decide&#32;to&#32;use&#32;IPC_NOWAIT&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00189"/>00189 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="_users_8c_source_1l00190"/>00190 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;EFAULT:
<anchor xml:id="_users_8c_source_1l00191"/>00191 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;address&#32;pointed&#32;by&#32;msgp&#32;inaccessible\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>);
<anchor xml:id="_users_8c_source_1l00192"/>00192 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="_users_8c_source_1l00193"/>00193 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;EIDRM:
<anchor xml:id="_users_8c_source_1l00194"/>00194 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;message&#32;queue&#32;removed\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>);
<anchor xml:id="_users_8c_source_1l00195"/>00195 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="_users_8c_source_1l00196"/>00196 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;EINTR:
<anchor xml:id="_users_8c_source_1l00197"/>00197 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;signal&#32;caught&#32;when&#32;waiting&#32;for&#32;queue&#32;to&#32;free\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>));
<anchor xml:id="_users_8c_source_1l00198"/>00198 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="_users_8c_source_1l00199"/>00199 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;EINVAL:
<anchor xml:id="_users_8c_source_1l00200"/>00200 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;invalid&#32;&#32;msqid&#32;&#32;value,&#32;&#32;or&#32;nonpositive&#32;mtype&#32;value,&#32;or&#32;invalid&#32;msgsz&#32;value\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>);
<anchor xml:id="_users_8c_source_1l00201"/>00201 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="_users_8c_source_1l00202"/>00202 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;ENOMEM:
<anchor xml:id="_users_8c_source_1l00203"/>00203 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;system&#32;out&#32;of&#32;memory\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>);&#32;<emphasis role="comment">/*&#32;should&#32;basically&#32;never&#32;happen&#32;I&#32;hope&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00204"/>00204 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="_users_8c_source_1l00205"/>00205 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">default</emphasis>:
<anchor xml:id="_users_8c_source_1l00206"/>00206 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;Transaction&#32;sent\n&quot;</emphasis>))
<anchor xml:id="_users_8c_source_1l00207"/>00207 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_common_8h_1aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</link>;
<anchor xml:id="_users_8c_source_1l00208"/>00208 &#32;&#32;&#32;&#32;}
<anchor xml:id="_users_8c_source_1l00209"/>00209 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1a95a086466eb975b4da063388dd397dd3">status</link>&#32;=&#32;aborted;
<anchor xml:id="_users_8c_source_1l00210"/>00210 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1a2ac06e48b5c5d403186f052dbefc3fe7">currBalance</link>&#32;+=&#32;(<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1a14236de313193a14b4dbdf442bcf2bb9">amount</link>&#32;+&#32;<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1af571e76d8e59b8452f38407799272e4a">reward</link>);
<anchor xml:id="_users_8c_source_1l00211"/>00211 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1af230afc0b56da7230ff9dacabbac1e25">outGoingTransactions</link>&#32;-=&#32;(<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1a14236de313193a14b4dbdf442bcf2bb9">amount</link>&#32;+&#32;<link linkend="_users_8c_1ad315771a76938636b622d7af42c8afd7">currTrans</link>.<link linkend="_structtransaction__t_1af571e76d8e59b8452f38407799272e4a">reward</link>);
<anchor xml:id="_users_8c_source_1l00212"/>00212 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;we&#32;can&#32;then&#32;track&#32;this&#32;type&#32;of&#32;aborted&#32;transactions&#32;but&#32;rn&#32;there&apos;s&#32;no&#32;need&#32;to&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00213"/>00213 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_common_8h_1a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</link>;
<anchor xml:id="_users_8c_source_1l00214"/>00214 }
<anchor xml:id="_users_8c_source_1l00215"/>00215 
<anchor xml:id="_users_8c_source_1l00216"/>00216 <emphasis role="comment">/*&#32;SIGUSR1&#32;handler,&#32;sends&#32;a&#32;transaction&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00217"/><link linkend="_users_8h_1a2419f7ac6a2d2282e04a8535b4b5c2f9">00217</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_users_8c_1a2419f7ac6a2d2282e04a8535b4b5c2f9">user_transactions_handle</link>(<emphasis role="keywordtype">int</emphasis>&#32;signum)
<anchor xml:id="_users_8c_source_1l00218"/>00218 {
<anchor xml:id="_users_8c_source_1l00219"/>00219 &#32;&#32;&#32;&#32;write(1,&#32;<emphasis role="stringliteral">&quot;::User::&#32;SIGUSR1&#32;received\n&quot;</emphasis>,&#32;27);
<anchor xml:id="_users_8c_source_1l00220"/>00220 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_users_8c_1a2ac06e48b5c5d403186f052dbefc3fe7">currBalance</link>&#32;&gt;&#32;2)
<anchor xml:id="_users_8c_source_1l00221"/>00221 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_users_8c_1af881b5c5f39090e7fc6c5c5d6630c7cb">send_transaction</link>();&#32;<emphasis role="comment">/*&#32;we&apos;re&#32;calling&#32;a&#32;printf&#32;which&#32;is&#32;not&#32;thread&#32;safe,&#32;need&#32;to&#32;fix&#32;somehow*/</emphasis>
<anchor xml:id="_users_8c_source_1l00222"/>00222 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>
<anchor xml:id="_users_8c_source_1l00223"/>00223 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;write(1,&#32;<emphasis role="stringliteral">&quot;::User::&#32;sorry&#32;balance&#32;too&#32;low\n&quot;</emphasis>,&#32;32);
<anchor xml:id="_users_8c_source_1l00224"/>00224 }
<anchor xml:id="_users_8c_source_1l00225"/>00225 
<anchor xml:id="_users_8c_source_1l00226"/>00226 <emphasis role="comment">/*&#32;CTRL-C&#32;handler&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00227"/><link linkend="_users_8h_1a9aab3bf870349762f604cebd8633aea5">00227</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_users_8c_1a9aab3bf870349762f604cebd8633aea5">user_interrupt_handle</link>(<emphasis role="keywordtype">int</emphasis>&#32;signum)
<anchor xml:id="_users_8c_source_1l00228"/>00228 {
<anchor xml:id="_users_8c_source_1l00229"/>00229 &#32;&#32;&#32;&#32;write(1,&#32;<emphasis role="stringliteral">&quot;::User::&#32;SIGINT&#32;received\n&quot;</emphasis>,&#32;26);
<anchor xml:id="_users_8c_source_1l00230"/>00230 &#32;&#32;&#32;&#32;exit(0);
<anchor xml:id="_users_8c_source_1l00231"/>00231 }
<anchor xml:id="_users_8c_source_1l00232"/>00232 
<anchor xml:id="_users_8c_source_1l00233"/><link linkend="_users_8c_1a0ddf1224851353fc92bfbff6f499fa97">00233</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_users_8c_1a0ddf1224851353fc92bfbff6f499fa97">main</link>(<emphasis role="keywordtype">int</emphasis>&#32;argc,&#32;<emphasis role="keywordtype">char</emphasis>&#32;*argv[])
<anchor xml:id="_users_8c_source_1l00234"/>00234 {
<anchor xml:id="_users_8c_source_1l00235"/>00235 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;amount,&#32;reward,&#32;retry;
<anchor xml:id="_users_8c_source_1l00236"/>00236 &#32;&#32;&#32;&#32;pid_t&#32;userPID,&#32;nodePID;
<anchor xml:id="_users_8c_source_1l00237"/>00237 
<anchor xml:id="_users_8c_source_1l00238"/>00238 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis>timespec&#32;<link linkend="_nodes_8h_1a3a6bc37f09273282c75d2fcc8b27f09e">randSleepTime</link>;
<anchor xml:id="_users_8c_source_1l00239"/>00239 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis>timespec&#32;<link linkend="_nodes_8h_1a45ff1b670dbcc1a3ff3c2657aba0b66b">sleepTimeRemaining</link>;
<anchor xml:id="_users_8c_source_1l00240"/>00240 
<anchor xml:id="_users_8c_source_1l00241"/>00241 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis>sembuf&#32;sops;
<anchor xml:id="_users_8c_source_1l00242"/>00242 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis><link linkend="_structmessage">message</link>&#32;transMsg;
<anchor xml:id="_users_8c_source_1l00243"/>00243 
<anchor xml:id="_users_8c_source_1l00244"/>00244 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis>sigaction&#32;saUSR1;
<anchor xml:id="_users_8c_source_1l00245"/>00245 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis>sigaction&#32;saINT;
<anchor xml:id="_users_8c_source_1l00246"/>00246 &#32;&#32;&#32;&#32;bzero(&amp;saUSR1,&#32;<emphasis role="keyword">sizeof</emphasis>(saUSR1));
<anchor xml:id="_users_8c_source_1l00247"/>00247 &#32;&#32;&#32;&#32;bzero(&amp;saINT,&#32;<emphasis role="keyword">sizeof</emphasis>(saINT));
<anchor xml:id="_users_8c_source_1l00248"/>00248 
<anchor xml:id="_users_8c_source_1l00249"/>00249 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>&#32;=&#32;getpid();&#32;<emphasis role="comment">/*&#32;set&#32;myPID&#32;value&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00250"/>00250 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;USERS_PID_ARGV&#32;%d\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;<link linkend="_common_8h_1abdb8ae9e0caeeaa6b02791a1991ec34e">USERS_PID_ARGV</link>))
<anchor xml:id="_users_8c_source_1l00251"/>00251 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;NODES_PID_ARGV&#32;%d\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;<link linkend="_common_8h_1aa26907b48e282ee32e55a0f21d90c651">NODES_PID_ARGV</link>))
<anchor xml:id="_users_8c_source_1l00252"/>00252 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;PARAMETERS_ARGV&#32;%d\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;<link linkend="_common_8h_1a8dc6d4d682e4f826ef23717f1b28d60c">PARAMETERS_ARGV</link>))
<anchor xml:id="_users_8c_source_1l00253"/>00253 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;LEDGER_ARGV&#32;%d\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;<link linkend="_common_8h_1acbabb34d7448290aade7aa93bb0c09ca">LEDGER_ARGV</link>))
<anchor xml:id="_users_8c_source_1l00254"/>00254 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;SEM_ID_PID_ARGV&#32;%d\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>,&#32;<link linkend="_common_8h_1a6b6ae98a167eeb9050cca5e9f9e5cf37">SEM_ID_ARGV</link>))
<anchor xml:id="_users_8c_source_1l00255"/>00255 
<anchor xml:id="_users_8c_source_1l00256"/>00256 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(argc&#32;==&#32;0)
<anchor xml:id="_users_8c_source_1l00257"/>00257 &#32;&#32;&#32;&#32;{
<anchor xml:id="_users_8c_source_1l00258"/>00258 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;:users:&#32;%d,&#32;no&#32;arguments&#32;passed,&#32;can&apos;t&#32;continue&#32;like&#32;this&#32;any&#32;more&#32;:C\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>);
<anchor xml:id="_users_8c_source_1l00259"/>00259 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_common_8h_1a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</link>;
<anchor xml:id="_users_8c_source_1l00260"/>00260 &#32;&#32;&#32;&#32;}
<anchor xml:id="_users_8c_source_1l00261"/>00261 
<anchor xml:id="_users_8c_source_1l00262"/>00262 &#32;&#32;&#32;&#32;srand(time(<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>));&#32;<emphasis role="comment">/*&#32;initialize&#32;rand&#32;function&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00263"/>00263 
<anchor xml:id="_users_8c_source_1l00264"/>00264 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1add037018869db8fbc785a9e0b24dd020">attach_ipc_objects</link>(argv);
<anchor xml:id="_users_8c_source_1l00265"/>00265 &#32;&#32;&#32;&#32;<link linkend="_users_8c_1a54d1d8f51781e0b3c58e16d3e04f2f74">signal_handlers_init</link>(&amp;saUSR1,&#32;&amp;saINT);
<anchor xml:id="_users_8c_source_1l00266"/>00266 &#32;&#32;&#32;&#32;transMsg.<link linkend="_structmessage_1a6e71692f0e74d6cd516fa62386afcfb4">mtype</link>&#32;=&#32;atol(<emphasis role="stringliteral">&quot;transaction&quot;</emphasis>);
<anchor xml:id="_users_8c_source_1l00267"/>00267 
<anchor xml:id="_users_8c_source_1l00268"/>00268 &#32;&#32;&#32;&#32;retry&#32;=&#32;<link linkend="_users_8c_1a963935917aae796fbb8f2728703adf04">par</link>-&gt;<link linkend="_structparameters_1ac2861693c2d9121c5ecad90de2189690">SO_RETRY</link>;
<anchor xml:id="_users_8c_source_1l00269"/>00269 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;(1)
<anchor xml:id="_users_8c_source_1l00270"/>00270 &#32;&#32;&#32;&#32;{
<anchor xml:id="_users_8c_source_1l00271"/>00271 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_users_8h_1a42693010975aeff6d524880e8ca2c717">SLEEP_TIME_SET</link>
<anchor xml:id="_users_8c_source_1l00272"/>00272 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">/*</emphasis>
<anchor xml:id="_users_8c_source_1l00273"/>00273 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;*&#32;save&#32;the&#32;time&#32;unslept&#32;when&#32;interrupted&#32;by&#32;SIGUSR1</emphasis>
<anchor xml:id="_users_8c_source_1l00274"/>00274 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;*&#32;so&#32;that&#32;we&#32;can&apos;t&#32;force&#32;transactions&#32;at&#32;a&#32;much&#32;greater&#32;speed</emphasis>
<anchor xml:id="_users_8c_source_1l00275"/>00275 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;*&#32;better&#32;to&#32;save&#32;it&#32;into&#32;a&#32;separate&#32;struct&#32;because&#32;clock_nanosleep</emphasis>
<anchor xml:id="_users_8c_source_1l00276"/>00276 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;*&#32;will&#32;not&#32;update&#32;it&#32;if&#32;the&#32;sleep&#32;is&#32;not&#32;interrupted</emphasis>
<anchor xml:id="_users_8c_source_1l00277"/>00277 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00278"/>00278 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;bzero(&amp;<link linkend="_nodes_8h_1a45ff1b670dbcc1a3ff3c2657aba0b66b">sleepTimeRemaining</link>,&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_nodes_8h_1a45ff1b670dbcc1a3ff3c2657aba0b66b">sleepTimeRemaining</link>));
<anchor xml:id="_users_8c_source_1l00279"/>00279 
<anchor xml:id="_users_8c_source_1l00280"/>00280 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_users_8c_1a2ac06e48b5c5d403186f052dbefc3fe7">currBalance</link>&#32;=&#32;100&#32;<emphasis role="comment">/*balance(myPID)*/</emphasis>;
<anchor xml:id="_users_8c_source_1l00281"/>00281 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_users_8c_1a2ac06e48b5c5d403186f052dbefc3fe7">currBalance</link>&#32;&gt;=&#32;2)
<anchor xml:id="_users_8c_source_1l00282"/>00282 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{
<anchor xml:id="_users_8c_source_1l00283"/>00283 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;userPID&#32;=&#32;<link linkend="_users_8c_1aaf15d0912c5fa42321118d1c652551d2">get_random_userPID</link>();
<anchor xml:id="_users_8c_source_1l00284"/>00284 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;nodePID&#32;=&#32;<link linkend="_users_8c_1a7a26cf1c5a9c15d42c4f3caeaa179b0e">get_random_nodePID</link>();
<anchor xml:id="_users_8c_source_1l00285"/>00285 
<anchor xml:id="_users_8c_source_1l00286"/>00286 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;amount&#32;=&#32;<link linkend="_common_8h_1a0d7644a795aa2dd33f01ef184f3f672a">RAND</link>(2,&#32;<link linkend="_users_8c_1a2ac06e48b5c5d403186f052dbefc3fe7">currBalance</link>);
<anchor xml:id="_users_8c_source_1l00287"/>00287 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;reward&#32;=&#32;<link linkend="_users_8c_1a6552301543b6d6d55cb62f88d40300a0">REWARD</link>(amount,&#32;<link linkend="_users_8c_1a963935917aae796fbb8f2728703adf04">par</link>-&gt;<link linkend="_structparameters_1a1e8968a80441b4a641d5ff3566af04f1">SO_REWARD</link>);
<anchor xml:id="_users_8c_source_1l00288"/>00288 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;amount&#32;-=&#32;reward;
<anchor xml:id="_users_8c_source_1l00289"/>00289 
<anchor xml:id="_users_8c_source_1l00290"/>00290 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_users_8c_1a9cceef0ffc7483e71c1cc4652a05cc1c">queue_to_pid</link>(nodePID);
<anchor xml:id="_users_8c_source_1l00291"/>00291 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_users_8c_1aad9c23bdb64131e376665a8dd7085f9b">transaction_init</link>(userPID,&#32;amount,&#32;reward);
<anchor xml:id="_users_8c_source_1l00292"/>00292 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_users_8c_1af881b5c5f39090e7fc6c5c5d6630c7cb">send_transaction</link>()&#32;==&#32;0)
<anchor xml:id="_users_8c_source_1l00293"/>00293 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;retry&#32;=&#32;<link linkend="_users_8c_1a963935917aae796fbb8f2728703adf04">par</link>-&gt;<link linkend="_structparameters_1ac2861693c2d9121c5ecad90de2189690">SO_RETRY</link>;
<anchor xml:id="_users_8c_source_1l00294"/>00294 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>
<anchor xml:id="_users_8c_source_1l00295"/>00295 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;retry--;
<anchor xml:id="_users_8c_source_1l00296"/>00296 
<anchor xml:id="_users_8c_source_1l00297"/>00297 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(retry&#32;==&#32;0)
<anchor xml:id="_users_8c_source_1l00298"/>00298 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{
<anchor xml:id="_users_8c_source_1l00299"/>00299 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_users_8c_1a959cd23eec8cbe2e56f5cc915e24ec2b">update_status</link>(2);
<anchor xml:id="_users_8c_source_1l00300"/>00300 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_common_8h_1a01c3892c16d6330e486637967ab0289b">MAX_RETRY</link>;
<anchor xml:id="_users_8c_source_1l00301"/>00301 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_users_8c_source_1l00302"/>00302 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_users_8h_1a44e89d523436fcbbf2c56e4fb335d509">SLEEP</link>
<anchor xml:id="_users_8c_source_1l00303"/>00303 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_users_8c_source_1l00304"/>00304 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>
<anchor xml:id="_users_8c_source_1l00305"/>00305 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{
<anchor xml:id="_users_8c_source_1l00306"/>00306 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;:users:&#32;%d&#32;went&#32;broke&#32;:/\n&quot;</emphasis>,&#32;<link linkend="_users_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>);
<anchor xml:id="_users_8c_source_1l00307"/>00307 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_users_8c_1a959cd23eec8cbe2e56f5cc915e24ec2b">update_status</link>(1);
<anchor xml:id="_users_8c_source_1l00308"/>00308 
<anchor xml:id="_users_8c_source_1l00309"/>00309 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">/*wait_for_incoming_transaction();&#32;/////////&#32;*/</emphasis>
<anchor xml:id="_users_8c_source_1l00310"/>00310 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_users_8c_source_1l00311"/>00311 &#32;&#32;&#32;&#32;}
<anchor xml:id="_users_8c_source_1l00312"/>00312 }
</programlisting></section>
