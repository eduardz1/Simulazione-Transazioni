<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="_master_8c_source" xml:lang="en-US">
<title>master.c</title>
<indexterm><primary>src/master.c</primary></indexterm>
Go to the documentation of this file.<programlisting linenumbering="unnumbered"><anchor xml:id="_master_8c_source_1l00001"/>00001 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_common_8h">include/common.h</link>&quot;</emphasis>
<anchor xml:id="_master_8c_source_1l00002"/>00002 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_master_8h">include/master.h</link>&quot;</emphasis>
<anchor xml:id="_master_8c_source_1l00003"/>00003 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_print_8h">include/print.h</link>&quot;</emphasis>
<anchor xml:id="_master_8c_source_1l00004"/>00004 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_parser_8h">include/parser.h</link>&quot;</emphasis>
<anchor xml:id="_master_8c_source_1l00005"/>00005 
<anchor xml:id="_master_8c_source_1l00006"/><link linkend="_master_8c_1a153c8fd37ad2953f8ea58a227f97eb9d">00006</link> <emphasis role="preprocessor">#define&#32;SHM_NUM&#32;4</emphasis>
<anchor xml:id="_master_8c_source_1l00007"/><link linkend="_master_8c_1a337d58ae606f3a5ec19972a7cbc4348f">00007</link> <emphasis role="preprocessor">#define&#32;SEM_NUM&#32;1</emphasis>
<anchor xml:id="_master_8c_source_1l00008"/><link linkend="_master_8c_1a7c551e7044ac9e4c3b9bd15add5824f5">00008</link> <emphasis role="preprocessor">#define&#32;IPC_NUM&#32;8</emphasis>
<anchor xml:id="_master_8c_source_1l00009"/>00009 
<anchor xml:id="_master_8c_source_1l00010"/><link linkend="_master_8c_1af55e8c51eb649983dc307ddf43a46ee6">00010</link> <emphasis role="preprocessor">#define&#32;USER_NAME&#32;&quot;./users&quot;</emphasis>
<anchor xml:id="_master_8c_source_1l00011"/><link linkend="_master_8c_1a8cc8d559acdd2f74085b20977182d5b7">00011</link> <emphasis role="preprocessor">#define&#32;NODE_NAME&#32;&quot;./nodes&quot;</emphasis>
<anchor xml:id="_master_8c_source_1l00012"/>00012 
<anchor xml:id="_master_8c_source_1l00013"/>00013 <emphasis role="comment">/*</emphasis>
<anchor xml:id="_master_8c_source_1l00014"/>00014 <emphasis role="comment">&#32;======================</emphasis>
<anchor xml:id="_master_8c_source_1l00015"/>00015 <emphasis role="comment">&#32;||&#32;GLOBAL&#32;VARIABLES&#32;||</emphasis>
<anchor xml:id="_master_8c_source_1l00016"/>00016 <emphasis role="comment">&#32;======================</emphasis>
<anchor xml:id="_master_8c_source_1l00017"/>00017 <emphasis role="comment">&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00018"/>00018 
<anchor xml:id="_master_8c_source_1l00019"/>00019 <emphasis role="comment">/*&#32;parameters&#32;of&#32;simulation&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00020"/><link linkend="_master_8c_1a963935917aae796fbb8f2728703adf04">00020</link> <emphasis role="keyword">struct&#32;</emphasis><link linkend="_structparameters">parameters</link>&#32;*<link linkend="_master_8c_1a963935917aae796fbb8f2728703adf04">par</link>;
<anchor xml:id="_master_8c_source_1l00021"/><link linkend="_master_8c_1af667a518a4feef7b7540ebac0cd618cf">00021</link> <link linkend="_structuser__t">user</link>&#32;*<link linkend="_master_8c_1af667a518a4feef7b7540ebac0cd618cf">usersPID</link>;
<anchor xml:id="_master_8c_source_1l00022"/><link linkend="_master_8c_1a803b35477f039b41487c3b1abee12b80">00022</link> <link linkend="_structnode__t">node</link>&#32;*<link linkend="_master_8c_1a803b35477f039b41487c3b1abee12b80">nodesPID</link>;
<anchor xml:id="_master_8c_source_1l00023"/><link linkend="_master_8c_1a61246e5e608d3240fbbee97c978af351">00023</link> <link linkend="_structledger__t">ledger</link>&#32;*<link linkend="_master_8c_1a61246e5e608d3240fbbee97c978af351">mainLedger</link>;
<anchor xml:id="_master_8c_source_1l00024"/>00024 
<anchor xml:id="_master_8c_source_1l00025"/><link linkend="_master_8c_1ae520355298e7bac453a556eeab7df45f">00025</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_master_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>;
<anchor xml:id="_master_8c_source_1l00026"/>00026 
<anchor xml:id="_master_8c_source_1l00027"/>00027 <emphasis role="comment">/*extern&#32;int&#32;usersPrematurelyDead&#32;=&#32;0;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00028"/>00028 
<anchor xml:id="_master_8c_source_1l00029"/>00029 <emphasis role="comment">/*</emphasis>
<anchor xml:id="_master_8c_source_1l00030"/>00030 <emphasis role="comment">&#32;======================</emphasis>
<anchor xml:id="_master_8c_source_1l00031"/>00031 <emphasis role="comment">&#32;||&#32;&#32;&#32;&#32;FUNCTIONS&#32;&#32;&#32;&#32;&#32;||</emphasis>
<anchor xml:id="_master_8c_source_1l00032"/>00032 <emphasis role="comment">&#32;======================</emphasis>
<anchor xml:id="_master_8c_source_1l00033"/>00033 <emphasis role="comment">&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00034"/>00034 
<anchor xml:id="_master_8c_source_1l00035"/>00035 <emphasis role="comment">/*&#32;make&#32;argv&#32;array&#32;with&#32;IPC&#32;IDs&#32;for&#32;user&#32;and&#32;nodes&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00036"/><link linkend="_master_8c_1a0a7e9839ec9892b7a45bcc5fa69dd988">00036</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_master_8c_1a0a7e9839ec9892b7a45bcc5fa69dd988">make_arguments</link>(<emphasis role="keywordtype">int</emphasis>&#32;*IPC_array,&#32;<emphasis role="keywordtype">char</emphasis>&#32;**argv)
<anchor xml:id="_master_8c_source_1l00037"/>00037 {
<anchor xml:id="_master_8c_source_1l00038"/>00038 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*uPID_array&#32;=&#32;malloc(3&#32;*&#32;<emphasis role="keyword">sizeof</emphasis>(IPC_array[0])&#32;+&#32;1);
<anchor xml:id="_master_8c_source_1l00039"/>00039 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*nPID_array&#32;=&#32;malloc(3&#32;*&#32;<emphasis role="keyword">sizeof</emphasis>(IPC_array[0])&#32;+&#32;1);
<anchor xml:id="_master_8c_source_1l00040"/>00040 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*<link linkend="_structparameters">parameters</link>&#32;=&#32;malloc(3&#32;*&#32;<emphasis role="keyword">sizeof</emphasis>(IPC_array[0])&#32;+&#32;1);
<anchor xml:id="_master_8c_source_1l00041"/>00041 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*<link linkend="_structledger__t">ledger</link>&#32;=&#32;malloc(3&#32;*&#32;<emphasis role="keyword">sizeof</emphasis>(IPC_array[0])&#32;+&#32;1);
<anchor xml:id="_master_8c_source_1l00042"/>00042 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;*<link linkend="_master_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>&#32;=&#32;malloc(3&#32;*&#32;<emphasis role="keyword">sizeof</emphasis>(IPC_array[0])&#32;+&#32;1);
<anchor xml:id="_master_8c_source_1l00043"/>00043 
<anchor xml:id="_master_8c_source_1l00044"/>00044 &#32;&#32;&#32;&#32;sprintf(uPID_array,&#32;<emphasis role="stringliteral">&quot;%d&quot;</emphasis>,&#32;IPC_array[0]);
<anchor xml:id="_master_8c_source_1l00045"/>00045 &#32;&#32;&#32;&#32;sprintf(nPID_array,&#32;<emphasis role="stringliteral">&quot;%d&quot;</emphasis>,&#32;IPC_array[1]);
<anchor xml:id="_master_8c_source_1l00046"/>00046 &#32;&#32;&#32;&#32;sprintf(<link linkend="_structparameters">parameters</link>,&#32;<emphasis role="stringliteral">&quot;%d&quot;</emphasis>,&#32;IPC_array[2]);
<anchor xml:id="_master_8c_source_1l00047"/>00047 &#32;&#32;&#32;&#32;sprintf(<link linkend="_structledger__t">ledger</link>,&#32;<emphasis role="stringliteral">&quot;%d&quot;</emphasis>,&#32;IPC_array[3]);
<anchor xml:id="_master_8c_source_1l00048"/>00048 &#32;&#32;&#32;&#32;sprintf(<link linkend="_master_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>,&#32;<emphasis role="stringliteral">&quot;%d&quot;</emphasis>,&#32;IPC_array[4]);
<anchor xml:id="_master_8c_source_1l00049"/>00049 
<anchor xml:id="_master_8c_source_1l00050"/>00050 &#32;&#32;&#32;&#32;argv[0]&#32;=&#32;<link linkend="_master_8c_1af55e8c51eb649983dc307ddf43a46ee6">USER_NAME</link>;&#32;<emphasis role="comment">/*&#32;need&#32;nodes&#32;to&#32;have&#32;a&#32;different&#32;name&#32;but&#32;not&#32;a&#32;priority&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00051"/>00051 &#32;&#32;&#32;&#32;argv[1]&#32;=&#32;uPID_array;
<anchor xml:id="_master_8c_source_1l00052"/>00052 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:master:&#32;argv[uPID]&#32;=&#32;%s\n&quot;</emphasis>,&#32;uPID_array))
<anchor xml:id="_master_8c_source_1l00053"/>00053 &#32;&#32;&#32;&#32;argv[2]&#32;=&#32;nPID_array;
<anchor xml:id="_master_8c_source_1l00054"/>00054 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:master:&#32;argv[nPID]&#32;=&#32;%s\n&quot;</emphasis>,&#32;nPID_array))
<anchor xml:id="_master_8c_source_1l00055"/>00055 &#32;&#32;&#32;&#32;argv[3]&#32;=&#32;<link linkend="_structparameters">parameters</link>;
<anchor xml:id="_master_8c_source_1l00056"/>00056 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:master:&#32;argv[par]&#32;=&#32;%s\n&quot;</emphasis>,&#32;<link linkend="_structparameters">parameters</link>))
<anchor xml:id="_master_8c_source_1l00057"/>00057 &#32;&#32;&#32;&#32;argv[4]&#32;=&#32;<link linkend="_common_8h_1af8b2bdfa2bfa44284c83a9d6994b13f1">ledger</link>;
<anchor xml:id="_master_8c_source_1l00058"/>00058 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:master:&#32;argv[ledger]&#32;=&#32;%s\n&quot;</emphasis>,&#32;<link linkend="_structledger__t">ledger</link>))
<anchor xml:id="_master_8c_source_1l00059"/>00059 &#32;&#32;&#32;&#32;argv[5]&#32;=&#32;<link linkend="_master_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>;
<anchor xml:id="_master_8c_source_1l00060"/>00060 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:master:&#32;argv[sem]&#32;=&#32;%s\n&quot;</emphasis>,&#32;<link linkend="_master_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>))
<anchor xml:id="_master_8c_source_1l00061"/>00061 &#32;&#32;&#32;&#32;argv[8]&#32;=&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>;&#32;<emphasis role="comment">/*&#32;Terminating&#32;argv&#32;with&#32;NULL&#32;value&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00062"/>00062 }
<anchor xml:id="_master_8c_source_1l00063"/>00063 
<anchor xml:id="_master_8c_source_1l00064"/>00064 <emphasis role="comment">/*&#32;fork&#32;and&#32;execve&#32;a&#32;&quot;./users&quot;&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00065"/><link linkend="_master_8h_1a9f9715b418947b3d25eaa102b494b7eb">00065</link> pid_t&#32;<link linkend="_master_8c_1ae58c1750af2fc1502557fa91b9258315">spawn_user</link>(<emphasis role="keywordtype">char</emphasis>&#32;*userArgv[])
<anchor xml:id="_master_8c_source_1l00066"/>00066 {
<anchor xml:id="_master_8c_source_1l00067"/>00067 &#32;&#32;&#32;&#32;pid_t&#32;<link linkend="_nodes_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>&#32;=&#32;fork();
<anchor xml:id="_master_8c_source_1l00068"/>00068 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:master:&#32;argv&#32;values:&#32;%s&#32;%s&#32;%s&#32;%s&#32;%s&#32;%s\n&quot;</emphasis>,&#32;userArgv[0],&#32;userArgv[1],&#32;userArgv[2],&#32;userArgv[3],&#32;userArgv[4],&#32;userArgv[5]))
<anchor xml:id="_master_8c_source_1l00069"/>00069 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">switch</emphasis>&#32;(<link linkend="_nodes_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>)
<anchor xml:id="_master_8c_source_1l00070"/>00070 &#32;&#32;&#32;&#32;{
<anchor xml:id="_master_8c_source_1l00071"/>00071 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;-1:&#32;<emphasis role="comment">/*&#32;Error&#32;case&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00072"/>00072 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;--&#32;Error&#32;forking&#32;for&#32;user\n&quot;</emphasis>);
<anchor xml:id="_master_8c_source_1l00073"/>00073 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="_master_8c_source_1l00074"/>00074 
<anchor xml:id="_master_8c_source_1l00075"/>00075 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;0:&#32;<emphasis role="comment">/*&#32;Child&#32;case&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00076"/>00076 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:master:&#32;Spawning&#32;user\n&quot;</emphasis>));
<anchor xml:id="_master_8c_source_1l00077"/>00077 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;execve(<link linkend="_master_8c_1af55e8c51eb649983dc307ddf43a46ee6">USER_NAME</link>,&#32;userArgv,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>);
<anchor xml:id="_master_8c_source_1l00078"/>00078 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_common_8h_1a8251bcdfc5c83845e0834adf211de033">TEST_ERROR</link>
<anchor xml:id="_master_8c_source_1l00079"/>00079 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;!!&#32;Message&#32;that&#32;should&#32;never&#32;be&#32;seen\n&quot;</emphasis>));
<anchor xml:id="_master_8c_source_1l00080"/>00080 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="_master_8c_source_1l00081"/>00081 
<anchor xml:id="_master_8c_source_1l00082"/>00082 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">default</emphasis>:
<anchor xml:id="_master_8c_source_1l00083"/>00083 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_nodes_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>;
<anchor xml:id="_master_8c_source_1l00084"/>00084 &#32;&#32;&#32;&#32;}
<anchor xml:id="_master_8c_source_1l00085"/>00085 }
<anchor xml:id="_master_8c_source_1l00086"/>00086 
<anchor xml:id="_master_8c_source_1l00087"/>00087 <emphasis role="comment">/*&#32;fork&#32;and&#32;execve&#32;a&#32;&quot;./nodes&quot;&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00088"/><link linkend="_master_8h_1ac4c522e4371812b5b4e5fd7982c58dd3">00088</link> pid_t&#32;<link linkend="_master_8c_1ab9c901d29850514f861a3760fffd505f">spawn_node</link>(<emphasis role="keywordtype">char</emphasis>&#32;*nodeArgv[])
<anchor xml:id="_master_8c_source_1l00089"/>00089 {
<anchor xml:id="_master_8c_source_1l00090"/>00090 &#32;&#32;&#32;&#32;pid_t&#32;<link linkend="_nodes_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>&#32;=&#32;fork();
<anchor xml:id="_master_8c_source_1l00091"/>00091 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:master:&#32;argv&#32;values:&#32;%s&#32;%s&#32;%s&#32;%s&#32;%s&#32;%s\n&quot;</emphasis>,&#32;nodeArgv[0],&#32;nodeArgv[1],&#32;nodeArgv[2],&#32;nodeArgv[3],&#32;nodeArgv[4],&#32;nodeArgv[5]))
<anchor xml:id="_master_8c_source_1l00092"/>00092 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">switch</emphasis>&#32;(<link linkend="_nodes_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>)
<anchor xml:id="_master_8c_source_1l00093"/>00093 &#32;&#32;&#32;&#32;{
<anchor xml:id="_master_8c_source_1l00094"/>00094 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;-1:&#32;<emphasis role="comment">/*&#32;Error&#32;case&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00095"/>00095 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;!!&#32;Error&#32;forking&#32;for&#32;node\n&quot;</emphasis>);
<anchor xml:id="_master_8c_source_1l00096"/>00096 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="_master_8c_source_1l00097"/>00097 
<anchor xml:id="_master_8c_source_1l00098"/>00098 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;0:&#32;<emphasis role="comment">/*&#32;Child&#32;case&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00099"/>00099 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:master:&#32;Spawning&#32;node\n&quot;</emphasis>));
<anchor xml:id="_master_8c_source_1l00100"/>00100 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;execve(<link linkend="_master_8c_1a8cc8d559acdd2f74085b20977182d5b7">NODE_NAME</link>,&#32;nodeArgv,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>);
<anchor xml:id="_master_8c_source_1l00101"/>00101 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_common_8h_1a8251bcdfc5c83845e0834adf211de033">TEST_ERROR</link>
<anchor xml:id="_master_8c_source_1l00102"/>00102 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;!!&#32;Message&#32;that&#32;should&#32;never&#32;be&#32;seen\n&quot;</emphasis>));
<anchor xml:id="_master_8c_source_1l00103"/>00103 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="_master_8c_source_1l00104"/>00104 
<anchor xml:id="_master_8c_source_1l00105"/>00105 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">default</emphasis>:
<anchor xml:id="_master_8c_source_1l00106"/>00106 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_nodes_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>;
<anchor xml:id="_master_8c_source_1l00107"/>00107 &#32;&#32;&#32;&#32;}
<anchor xml:id="_master_8c_source_1l00108"/>00108 }
<anchor xml:id="_master_8c_source_1l00109"/>00109 
<anchor xml:id="_master_8c_source_1l00110"/>00110 <emphasis role="comment">/*&#32;attach&#32;usersPID,&#32;nodesPID,&#32;par&#32;and&#32;mainLedger&#32;to&#32;shared&#32;memory,&#32;returns&#32;an&#32;array&#32;with&#32;respective&#32;IDs&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00111"/><link linkend="_master_8h_1af65ef707ebfa9cc135e6d466c75dbda8">00111</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_master_8c_1a402674278f054cd8161d84815dcdd7cc">shared_memory_objects_init</link>(<emphasis role="keywordtype">int</emphasis>&#32;*shmArray)
<anchor xml:id="_master_8c_source_1l00112"/>00112 {
<anchor xml:id="_master_8c_source_1l00113"/>00113 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;shared&#32;memory&#32;segments&#32;IDs&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00114"/>00114 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;usersPID_ID;
<anchor xml:id="_master_8c_source_1l00115"/>00115 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;nodesPID_ID;
<anchor xml:id="_master_8c_source_1l00116"/>00116 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;mainLedger_ID;
<anchor xml:id="_master_8c_source_1l00117"/>00117 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;par_ID;
<anchor xml:id="_master_8c_source_1l00118"/>00118 
<anchor xml:id="_master_8c_source_1l00119"/>00119 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;parameters&#32;init&#32;and&#32;read&#32;from&#32;conf&#32;file&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00120"/>00120 &#32;&#32;&#32;&#32;par_ID&#32;=&#32;shmget(<link linkend="_common_8h_1a682c31ec4c2347e42bb80ea43ccb4438">SHM_PARAMETERS</link>,&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_master_8c_1a963935917aae796fbb8f2728703adf04">par</link>),&#32;0600&#32;|&#32;IPC_CREAT&#32;|&#32;IPC_EXCL);
<anchor xml:id="_master_8c_source_1l00121"/>00121 &#32;&#32;&#32;&#32;<link linkend="_common_8h_1a8251bcdfc5c83845e0834adf211de033">TEST_ERROR</link>
<anchor xml:id="_master_8c_source_1l00122"/>00122 &#32;&#32;&#32;&#32;<link linkend="_master_8c_1a963935917aae796fbb8f2728703adf04">par</link>&#32;=&#32;(<emphasis role="keyword">struct&#32;</emphasis><link linkend="_structparameters">parameters</link>&#32;*)shmat(par_ID,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>,&#32;0);
<anchor xml:id="_master_8c_source_1l00123"/>00123 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_parser_8h_1aa51f83495fd93bbb234b08030216c91a">parse_parameters</link>(<link linkend="_master_8c_1a963935917aae796fbb8f2728703adf04">par</link>)&#32;==&#32;<link linkend="_parser_8h_1ad223dab1d6a66f81b6b0c6c268a19a3f">CONF_ERROR</link>)
<anchor xml:id="_master_8c_source_1l00124"/>00124 &#32;&#32;&#32;&#32;{
<anchor xml:id="_master_8c_source_1l00125"/>00125 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;--&#32;Error&#32;reading&#32;conf&#32;file,&#32;defaulting&#32;to&#32;conf#1\n&quot;</emphasis>));
<anchor xml:id="_master_8c_source_1l00126"/>00126 &#32;&#32;&#32;&#32;}
<anchor xml:id="_master_8c_source_1l00127"/>00127 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>
<anchor xml:id="_master_8c_source_1l00128"/>00128 &#32;&#32;&#32;&#32;{
<anchor xml:id="_master_8c_source_1l00129"/>00129 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;--&#32;Conf&#32;file&#32;read&#32;successful\n&quot;</emphasis>));
<anchor xml:id="_master_8c_source_1l00130"/>00130 &#32;&#32;&#32;&#32;}
<anchor xml:id="_master_8c_source_1l00131"/>00131 <emphasis role="preprocessor">#ifdef&#32;DEBUG</emphasis>
<anchor xml:id="_master_8c_source_1l00132"/>00132 &#32;&#32;&#32;&#32;<link linkend="_print_8h_1a7632b11ea6036c833f5c2cd3cd0bb087">print_parameters</link>(<link linkend="_master_8c_1a963935917aae796fbb8f2728703adf04">par</link>);
<anchor xml:id="_master_8c_source_1l00133"/>00133 <emphasis role="preprocessor">#endif</emphasis>
<anchor xml:id="_master_8c_source_1l00134"/>00134 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;(users_t)&#32;and&#32;(nodes_t)&#32;arrays&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00135"/>00135 &#32;&#32;&#32;&#32;usersPID_ID&#32;=&#32;shmget(<link linkend="_common_8h_1a3baba14bf322fc6a6367f5ae6795d440">SHM_USERS_ARRAY</link>,
<anchor xml:id="_master_8c_source_1l00136"/>00136 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;(<link linkend="_master_8c_1a963935917aae796fbb8f2728703adf04">par</link>-&gt;<link linkend="_structparameters_1a1a7bfa0882f03d573b4e419d02f041f8">SO_USER_NUM</link>)&#32;*&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_structuser__t">user</link>),
<anchor xml:id="_master_8c_source_1l00137"/>00137 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;0600&#32;|&#32;IPC_CREAT&#32;|&#32;IPC_EXCL);
<anchor xml:id="_master_8c_source_1l00138"/>00138 &#32;&#32;&#32;&#32;<link linkend="_common_8h_1a8251bcdfc5c83845e0834adf211de033">TEST_ERROR</link>
<anchor xml:id="_master_8c_source_1l00139"/>00139 &#32;&#32;&#32;&#32;nodesPID_ID&#32;=&#32;shmget(<link linkend="_common_8h_1a55de6fde37952d6cbbf28f2ed2299ace">SHM_NODES_ARRAY</link>,
<anchor xml:id="_master_8c_source_1l00140"/>00140 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;(<link linkend="_master_8c_1a963935917aae796fbb8f2728703adf04">par</link>-&gt;<link linkend="_structparameters_1a379d08051847c4f98268a27001b06261">SO_NODES_NUM</link>)&#32;*&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_structnode__t">node</link>),
<anchor xml:id="_master_8c_source_1l00141"/>00141 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;0600&#32;|&#32;IPC_CREAT&#32;|&#32;IPC_EXCL);
<anchor xml:id="_master_8c_source_1l00142"/>00142 &#32;&#32;&#32;&#32;<link linkend="_common_8h_1a8251bcdfc5c83845e0834adf211de033">TEST_ERROR</link>
<anchor xml:id="_master_8c_source_1l00143"/>00143 &#32;&#32;&#32;&#32;<link linkend="_master_8c_1af667a518a4feef7b7540ebac0cd618cf">usersPID</link>&#32;=&#32;(<link linkend="_structuser__t">user</link>&#32;*)shmat(usersPID_ID,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>,&#32;0);
<anchor xml:id="_master_8c_source_1l00144"/>00144 &#32;&#32;&#32;&#32;<link linkend="_master_8c_1a803b35477f039b41487c3b1abee12b80">nodesPID</link>&#32;=&#32;(<link linkend="_structnode__t">node</link>&#32;*)shmat(nodesPID_ID,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>,&#32;0);
<anchor xml:id="_master_8c_source_1l00145"/>00145 
<anchor xml:id="_master_8c_source_1l00146"/>00146 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;mainLedger&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00147"/>00147 &#32;&#32;&#32;&#32;mainLedger_ID&#32;=&#32;shmget(<link linkend="_common_8h_1a5de1e6971273cfe0a7fdd4570401eb53">SHM_LEDGER</link>,
<anchor xml:id="_master_8c_source_1l00148"/>00148 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;(<link linkend="_master_8c_1a963935917aae796fbb8f2728703adf04">par</link>-&gt;<link linkend="_structparameters_1a379d08051847c4f98268a27001b06261">SO_NODES_NUM</link>)&#32;*&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_structnode__t">node</link>),
<anchor xml:id="_master_8c_source_1l00149"/>00149 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;0600&#32;|&#32;IPC_CREAT&#32;|&#32;IPC_EXCL);
<anchor xml:id="_master_8c_source_1l00150"/>00150 &#32;&#32;&#32;&#32;<link linkend="_common_8h_1a8251bcdfc5c83845e0834adf211de033">TEST_ERROR</link>
<anchor xml:id="_master_8c_source_1l00151"/>00151 &#32;&#32;&#32;&#32;<link linkend="_master_8c_1a61246e5e608d3240fbbee97c978af351">mainLedger</link>&#32;=&#32;(<link linkend="_structledger__t">ledger</link>&#32;*)shmat(mainLedger_ID,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>,&#32;0);
<anchor xml:id="_master_8c_source_1l00152"/>00152 
<anchor xml:id="_master_8c_source_1l00153"/>00153 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;for&#32;deallocation&#32;so&#32;that&#32;they&#32;are&#32;automatically</emphasis>
<anchor xml:id="_master_8c_source_1l00154"/>00154 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;*&#32;removed&#32;once&#32;master&#32;dies</emphasis>
<anchor xml:id="_master_8c_source_1l00155"/>00155 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00156"/>00156 &#32;&#32;&#32;&#32;shmctl(usersPID_ID,&#32;IPC_RMID,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>);
<anchor xml:id="_master_8c_source_1l00157"/>00157 &#32;&#32;&#32;&#32;shmctl(nodesPID_ID,&#32;IPC_RMID,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>);
<anchor xml:id="_master_8c_source_1l00158"/>00158 &#32;&#32;&#32;&#32;shmctl(par_ID,&#32;IPC_RMID,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>);
<anchor xml:id="_master_8c_source_1l00159"/>00159 &#32;&#32;&#32;&#32;shmctl(mainLedger_ID,&#32;IPC_RMID,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>);
<anchor xml:id="_master_8c_source_1l00160"/>00160 
<anchor xml:id="_master_8c_source_1l00161"/>00161 &#32;&#32;&#32;&#32;shmArray[0]&#32;=&#32;usersPID_ID;
<anchor xml:id="_master_8c_source_1l00162"/>00162 &#32;&#32;&#32;&#32;shmArray[1]&#32;=&#32;nodesPID_ID;
<anchor xml:id="_master_8c_source_1l00163"/>00163 &#32;&#32;&#32;&#32;shmArray[2]&#32;=&#32;par_ID;
<anchor xml:id="_master_8c_source_1l00164"/>00164 &#32;&#32;&#32;&#32;shmArray[3]&#32;=&#32;mainLedger_ID;
<anchor xml:id="_master_8c_source_1l00165"/>00165 }
<anchor xml:id="_master_8c_source_1l00166"/>00166 
<anchor xml:id="_master_8c_source_1l00167"/><link linkend="_master_8h_1a808faa6034b867dc92c3878d95cec5d0">00167</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_master_8c_1a808faa6034b867dc92c3878d95cec5d0">semaphores_init</link>()
<anchor xml:id="_master_8c_source_1l00168"/>00168 {
<anchor xml:id="_master_8c_source_1l00169"/>00169 &#32;&#32;&#32;&#32;<link linkend="_master_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>&#32;=&#32;semget(<link linkend="_common_8h_1a1abb954531733b3c7b64d0d78a75df2a">SEM_MASTER</link>,&#32;1,&#32;0600&#32;|&#32;IPC_CREAT&#32;|&#32;IPC_EXCL);
<anchor xml:id="_master_8c_source_1l00170"/>00170 &#32;&#32;&#32;&#32;<link linkend="_common_8h_1a8251bcdfc5c83845e0834adf211de033">TEST_ERROR</link>
<anchor xml:id="_master_8c_source_1l00171"/>00171 &#32;&#32;&#32;&#32;<link linkend="_debug_8h_1a494d31903e7b0333dfa03b0778679113">TRACE</link>((<emphasis role="stringliteral">&quot;:master:&#32;semID&#32;is&#32;%d\n&quot;</emphasis>,&#32;<link linkend="_master_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>));
<anchor xml:id="_master_8c_source_1l00172"/>00172 }
<anchor xml:id="_master_8c_source_1l00173"/>00173 
<anchor xml:id="_master_8c_source_1l00174"/>00174 <emphasis role="comment">/*&#32;makes&#32;an&#32;array&#32;with&#32;every&#32;IPC&#32;object&#32;ID&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00175"/><link linkend="_master_8h_1af39360a8f6b9dda80c2adfe9f456f75e">00175</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_master_8c_1ac58bbbc0433b1fd55eff29fd2040e88c">make_ipc_array</link>(<emphasis role="keywordtype">int</emphasis>&#32;*IPC_array)
<anchor xml:id="_master_8c_source_1l00176"/>00176 {
<anchor xml:id="_master_8c_source_1l00177"/>00177 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;shmIDs[<link linkend="_master_8c_1a153c8fd37ad2953f8ea58a227f97eb9d">SHM_NUM</link>];&#32;<emphasis role="comment">/*&#32;array&#32;containing&#32;every&#32;shared&#32;memory&#32;ID&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00178"/>00178 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;semIDs[1]&#32;=&#32;{0};
<anchor xml:id="_master_8c_source_1l00179"/>00179 
<anchor xml:id="_master_8c_source_1l00180"/>00180 &#32;&#32;&#32;&#32;<link linkend="_master_8c_1a402674278f054cd8161d84815dcdd7cc">shared_memory_objects_init</link>(shmIDs);
<anchor xml:id="_master_8c_source_1l00181"/>00181 &#32;&#32;&#32;&#32;semIDs[0]&#32;=&#32;<link linkend="_master_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>;
<anchor xml:id="_master_8c_source_1l00182"/>00182 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;semaphores_init(semIDs);&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00183"/>00183 &#32;&#32;&#32;&#32;memcpy(IPC_array,&#32;shmIDs,&#32;<link linkend="_master_8c_1a153c8fd37ad2953f8ea58a227f97eb9d">SHM_NUM</link>&#32;*&#32;<emphasis role="keyword">sizeof</emphasis>(<emphasis role="keywordtype">int</emphasis>));
<anchor xml:id="_master_8c_source_1l00184"/>00184 &#32;&#32;&#32;&#32;memcpy(IPC_array&#32;+&#32;<link linkend="_master_8c_1a153c8fd37ad2953f8ea58a227f97eb9d">SHM_NUM</link>,&#32;shmIDs,&#32;<link linkend="_master_8c_1a337d58ae606f3a5ec19972a7cbc4348f">SEM_NUM</link>&#32;*&#32;<emphasis role="keyword">sizeof</emphasis>(<emphasis role="keywordtype">int</emphasis>));
<anchor xml:id="_master_8c_source_1l00185"/>00185 }
<anchor xml:id="_master_8c_source_1l00186"/>00186 
<anchor xml:id="_master_8c_source_1l00187"/>00187 <emphasis role="comment">/*&#32;CTRL-C&#32;handler&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00188"/><link linkend="_master_8h_1a6732beb5ef32cd411a23cf0d8c915e37">00188</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_master_8c_1a6732beb5ef32cd411a23cf0d8c915e37">master_interrupt_handle</link>(<emphasis role="keywordtype">int</emphasis>&#32;signum)
<anchor xml:id="_master_8c_source_1l00189"/>00189 {
<anchor xml:id="_master_8c_source_1l00190"/>00190 &#32;&#32;&#32;&#32;write(1,&#32;<emphasis role="stringliteral">&quot;::Master::&#32;SIGINT&#32;ricevuto\n&quot;</emphasis>,&#32;28);
<anchor xml:id="_master_8c_source_1l00191"/>00191 &#32;&#32;&#32;&#32;killpg(0,&#32;SIGINT);
<anchor xml:id="_master_8c_source_1l00192"/>00192 
<anchor xml:id="_master_8c_source_1l00193"/>00193 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;just&#32;to&#32;avoid&#32;printing&#32;before&#32;everyone&#32;has&#32;finished*/</emphasis>
<anchor xml:id="_master_8c_source_1l00194"/>00194 &#32;&#32;&#32;&#32;sleep(1);
<anchor xml:id="_master_8c_source_1l00195"/>00195 &#32;&#32;&#32;&#32;<link linkend="_print_8h_1a3210b536ef064414b1736cd2e9b7d3bd">final_print</link>(getpid(),&#32;<link linkend="_master_8c_1af667a518a4feef7b7540ebac0cd618cf">usersPID</link>,&#32;<link linkend="_master_8c_1a803b35477f039b41487c3b1abee12b80">nodesPID</link>,&#32;<link linkend="_master_8c_1a963935917aae796fbb8f2728703adf04">par</link>);
<anchor xml:id="_master_8c_source_1l00196"/>00196 
<anchor xml:id="_master_8c_source_1l00197"/>00197 &#32;&#32;&#32;&#32;<emphasis role="comment">/*</emphasis>
<anchor xml:id="_master_8c_source_1l00198"/>00198 <emphasis role="comment">&#32;&#32;&#32;&#32;int&#32;status;</emphasis>
<anchor xml:id="_master_8c_source_1l00199"/>00199 <emphasis role="comment"></emphasis>
<anchor xml:id="_master_8c_source_1l00200"/>00200 <emphasis role="comment">&#32;&#32;&#32;&#32;while&#32;(wait(&amp;status)&#32;!=&#32;-1)</emphasis>
<anchor xml:id="_master_8c_source_1l00201"/>00201 <emphasis role="comment">&#32;&#32;&#32;&#32;{</emphasis>
<anchor xml:id="_master_8c_source_1l00202"/>00202 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;status&#32;&gt;&gt;&#32;8;&#32;/*&#32;no&#32;idea&#32;about&#32;what&#32;it&#32;does&#32;please&#32;help&#32;*</emphasis>
<anchor xml:id="_master_8c_source_1l00203"/>00203 <emphasis role="comment">&#32;&#32;&#32;&#32;}&#32;</emphasis>
<anchor xml:id="_master_8c_source_1l00204"/>00204 <emphasis role="comment">&#32;&#32;&#32;&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00205"/>00205 
<anchor xml:id="_master_8c_source_1l00206"/>00206 &#32;&#32;&#32;&#32;semctl(<link linkend="_master_8c_1ae520355298e7bac453a556eeab7df45f">semID</link>,&#32;1,&#32;IPC_RMID);
<anchor xml:id="_master_8c_source_1l00207"/>00207 &#32;&#32;&#32;&#32;exit(0);
<anchor xml:id="_master_8c_source_1l00208"/>00208 }
<anchor xml:id="_master_8c_source_1l00209"/>00209 
<anchor xml:id="_master_8c_source_1l00210"/><link linkend="_master_8c_1a0ddf1224851353fc92bfbff6f499fa97">00210</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_master_8c_1a0ddf1224851353fc92bfbff6f499fa97">main</link>(<emphasis role="keywordtype">int</emphasis>&#32;argc,&#32;<emphasis role="keywordtype">char</emphasis>&#32;*argv[])
<anchor xml:id="_master_8c_source_1l00211"/>00211 {
<anchor xml:id="_master_8c_source_1l00212"/>00212 &#32;&#32;&#32;&#32;pid_t&#32;<link linkend="_nodes_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>&#32;=&#32;getpid();
<anchor xml:id="_master_8c_source_1l00213"/>00213 
<anchor xml:id="_master_8c_source_1l00214"/>00214 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;uCounter,&#32;nCounter,&#32;returnVal;
<anchor xml:id="_master_8c_source_1l00215"/>00215 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;simTime;
<anchor xml:id="_master_8c_source_1l00216"/>00216 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;ipcObjectsIDs[<link linkend="_master_8c_1a7c551e7044ac9e4c3b9bd15add5824f5">IPC_NUM</link>];
<anchor xml:id="_master_8c_source_1l00217"/>00217 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">char</emphasis>&#32;**argvSpawns&#32;=&#32;malloc(8*32);
<anchor xml:id="_master_8c_source_1l00218"/>00218 
<anchor xml:id="_master_8c_source_1l00219"/>00219 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis>sigaction&#32;sa;
<anchor xml:id="_master_8c_source_1l00220"/>00220 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis>sembuf&#32;sops;
<anchor xml:id="_master_8c_source_1l00221"/>00221 
<anchor xml:id="_master_8c_source_1l00222"/>00222 &#32;&#32;&#32;&#32;<link linkend="_master_8c_1a808faa6034b867dc92c3878d95cec5d0">semaphores_init</link>();
<anchor xml:id="_master_8c_source_1l00223"/>00223 &#32;&#32;&#32;&#32;<link linkend="_master_8c_1ac58bbbc0433b1fd55eff29fd2040e88c">make_ipc_array</link>(ipcObjectsIDs);
<anchor xml:id="_master_8c_source_1l00224"/>00224 &#32;&#32;&#32;&#32;<link linkend="_master_8c_1a0a7e9839ec9892b7a45bcc5fa69dd988">make_arguments</link>(ipcObjectsIDs,&#32;argvSpawns);
<anchor xml:id="_master_8c_source_1l00225"/>00225 &#32;&#32;&#32;&#32;<link linkend="_master_8c_1a61246e5e608d3240fbbee97c978af351">mainLedger</link>&#32;=&#32;<link linkend="_common_8c_1a92d436f484409e36c57caaa0b45ae9da">ledger_init</link>();
<anchor xml:id="_master_8c_source_1l00226"/>00226 
<anchor xml:id="_master_8c_source_1l00227"/>00227 &#32;&#32;&#32;&#32;simTime&#32;=&#32;<link linkend="_master_8c_1a963935917aae796fbb8f2728703adf04">par</link>-&gt;<link linkend="_structparameters_1a86c91cb21e43e2f92651c149f93f0dc5">SO_SIM_SEC</link>;
<anchor xml:id="_master_8c_source_1l00228"/>00228 
<anchor xml:id="_master_8c_source_1l00229"/>00229 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;--&#32;SIGNAL&#32;HANDLER&#32;--</emphasis>
<anchor xml:id="_master_8c_source_1l00230"/>00230 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;*&#32;first&#32;set&#32;all&#32;bytes&#32;of&#32;sigation&#32;to&#32;0</emphasis>
<anchor xml:id="_master_8c_source_1l00231"/>00231 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;*&#32;then&#32;initialize&#32;sa.handler&#32;to&#32;a&#32;pointer&#32;to&#32;the&#32;function&#32;interrupt_handle</emphasis>
<anchor xml:id="_master_8c_source_1l00232"/>00232 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;*&#32;then&#32;set&#32;the&#32;handler&#32;to&#32;handle&#32;SIGINT&#32;signals&#32;((struct&#32;sigaction&#32;*oldact)&#32;=&#32;NULL)</emphasis>
<anchor xml:id="_master_8c_source_1l00233"/>00233 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00234"/>00234 &#32;&#32;&#32;&#32;bzero(&amp;sa,&#32;<emphasis role="keyword">sizeof</emphasis>(sa));
<anchor xml:id="_master_8c_source_1l00235"/>00235 &#32;&#32;&#32;&#32;sa.sa_handler&#32;=&#32;<link linkend="_master_8c_1a6732beb5ef32cd411a23cf0d8c915e37">master_interrupt_handle</link>;
<anchor xml:id="_master_8c_source_1l00236"/>00236 &#32;&#32;&#32;&#32;sigaction(SIGINT,&#32;&amp;sa,&#32;<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>);
<anchor xml:id="_master_8c_source_1l00237"/>00237 
<anchor xml:id="_master_8c_source_1l00238"/>00238 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(nCounter&#32;=&#32;0;&#32;nCounter&#32;&lt;&#32;<link linkend="_master_8c_1a963935917aae796fbb8f2728703adf04">par</link>-&gt;<link linkend="_structparameters_1a379d08051847c4f98268a27001b06261">SO_NODES_NUM</link>;&#32;nCounter++)
<anchor xml:id="_master_8c_source_1l00239"/>00239 &#32;&#32;&#32;&#32;{
<anchor xml:id="_master_8c_source_1l00240"/>00240 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_sem_8h_1a0376b2ead2de10bb7ab6a4d21ec304e9">LOCK</link>
<anchor xml:id="_master_8c_source_1l00241"/>00241 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_master_8c_1a803b35477f039b41487c3b1abee12b80">nodesPID</link>[nCounter]
<anchor xml:id="_master_8c_source_1l00242"/>00242 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.<link linkend="_structnode__t_1a3298103f7912ec98c0f00205b2ac218d">status</link>&#32;=&#32;available;
<anchor xml:id="_master_8c_source_1l00243"/>00243 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_master_8c_1a803b35477f039b41487c3b1abee12b80">nodesPID</link>[nCounter].<link linkend="_structnode__t_1ae0d46a978d5cd6707411f276ad869b9c">pid</link>&#32;=&#32;<link linkend="_master_8c_1ab9c901d29850514f861a3760fffd505f">spawn_node</link>(argvSpawns);
<anchor xml:id="_master_8c_source_1l00244"/>00244 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_sem_8h_1ac82effb31e82e32254efc8b57251d59e">UNLOCK</link>
<anchor xml:id="_master_8c_source_1l00245"/>00245 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(getpid()&#32;!=&#32;<link linkend="_nodes_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>)
<anchor xml:id="_master_8c_source_1l00246"/>00246 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{
<anchor xml:id="_master_8c_source_1l00247"/>00247 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>;
<anchor xml:id="_master_8c_source_1l00248"/>00248 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_master_8c_source_1l00249"/>00249 &#32;&#32;&#32;&#32;}
<anchor xml:id="_master_8c_source_1l00250"/>00250 
<anchor xml:id="_master_8c_source_1l00251"/>00251 &#32;&#32;&#32;&#32;<emphasis role="comment">/*usersPrematurelyDead&#32;=&#32;0;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00252"/>00252 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(uCounter&#32;=&#32;0;&#32;uCounter&#32;&lt;&#32;<link linkend="_master_8c_1a963935917aae796fbb8f2728703adf04">par</link>-&gt;<link linkend="_structparameters_1a1a7bfa0882f03d573b4e419d02f041f8">SO_USER_NUM</link>;&#32;uCounter++)
<anchor xml:id="_master_8c_source_1l00253"/>00253 &#32;&#32;&#32;&#32;{
<anchor xml:id="_master_8c_source_1l00254"/>00254 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_sem_8h_1a0376b2ead2de10bb7ab6a4d21ec304e9">LOCK</link>
<anchor xml:id="_master_8c_source_1l00255"/>00255 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_master_8c_1af667a518a4feef7b7540ebac0cd618cf">usersPID</link>[uCounter]
<anchor xml:id="_master_8c_source_1l00256"/>00256 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.<link linkend="_structuser__t_1a2f25fcb4ca138820780f3fc6ee156d17">status</link>&#32;=&#32;alive;
<anchor xml:id="_master_8c_source_1l00257"/>00257 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_master_8c_1af667a518a4feef7b7540ebac0cd618cf">usersPID</link>[uCounter].<link linkend="_structuser__t_1ae0d46a978d5cd6707411f276ad869b9c">pid</link>&#32;=&#32;<link linkend="_master_8c_1ae58c1750af2fc1502557fa91b9258315">spawn_user</link>(argvSpawns);
<anchor xml:id="_master_8c_source_1l00258"/>00258 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_sem_8h_1ac82effb31e82e32254efc8b57251d59e">UNLOCK</link>
<anchor xml:id="_master_8c_source_1l00259"/>00259 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(getpid()&#32;!=&#32;<link linkend="_nodes_8c_1af97c23712a0bab92e0ca95694e85282e">myPID</link>)
<anchor xml:id="_master_8c_source_1l00260"/>00260 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{
<anchor xml:id="_master_8c_source_1l00261"/>00261 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">switch</emphasis>&#32;(returnVal&#32;=&#32;wait(<link linkend="_common_8h_1a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</link>))
<anchor xml:id="_master_8c_source_1l00262"/>00262 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{
<anchor xml:id="_master_8c_source_1l00263"/>00263 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_common_8h_1a01c3892c16d6330e486637967ab0289b">MAX_RETRY</link>:
<anchor xml:id="_master_8c_source_1l00264"/>00264 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;change&#32;status&#32;in&#32;usersPID&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00265"/>00265 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;printf(<emphasis role="stringliteral">&quot;User&#32;%d&#32;has&#32;died&#32;because&#32;of&#32;too&#32;many&#32;retries&#32;:(\n&quot;</emphasis>,&#32;getpid());
<anchor xml:id="_master_8c_source_1l00266"/>00266 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="_master_8c_source_1l00267"/>00267 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_master_8c_source_1l00268"/>00268 
<anchor xml:id="_master_8c_source_1l00269"/>00269 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>;
<anchor xml:id="_master_8c_source_1l00270"/>00270 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_master_8c_source_1l00271"/>00271 &#32;&#32;&#32;&#32;}
<anchor xml:id="_master_8c_source_1l00272"/>00272 
<anchor xml:id="_master_8c_source_1l00273"/>00273 &#32;&#32;&#32;&#32;sleep(simTime);
<anchor xml:id="_master_8c_source_1l00274"/>00274 
<anchor xml:id="_master_8c_source_1l00275"/>00275 &#32;&#32;&#32;&#32;<link linkend="_print_8h_1abba0d38395714b105fe448566b916b24">print_time_to_die</link>();
<anchor xml:id="_master_8c_source_1l00276"/>00276 &#32;&#32;&#32;&#32;killpg(0,&#32;SIGINT);&#32;<emphasis role="comment">/*&#32;our&#32;sigint&#32;handler&#32;needs&#32;to&#32;do&#32;quite&#32;a&#32;lot&#32;of&#32;things&#32;to&#32;print&#32;the&#32;wall&#32;of&#32;test&#32;below&#32;*/</emphasis>
<anchor xml:id="_master_8c_source_1l00277"/>00277 
<anchor xml:id="_master_8c_source_1l00278"/>00278 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
<anchor xml:id="_master_8c_source_1l00279"/>00279 }
</programlisting></section>
